Светодиодный индикатор parled12
===============================

В рамках проекта parled12 разрабатываются следующие компоненты:
1. Устройство из 12 светодиодов, подключаемых к параллельному порту.
2. Демон для управления устройством.

В проекте имеется несколько каталогов.

Каталог proof
-------------

Здесь размещаются тестовые программы, при помощи которых проверялась принципиальная возможность управления светодиодами на параллельном порту. Для отладки к порту подключалась пара последовательно соединённых деталей - светодиод и резистор, который ограничивал максимальный ток, проходящий через светодиод для защиты светодиода от перегорания.

parled12a.c - управление светодиодами на параллельном порту осуществляется через специальный файл /dev/port, в который отображаются порты ввода-вывода компьютера. При запуске без аргументов программа выводит справку по использованию:

```
Usage: parled12a [--port <port>] --set <value>
       parled12a [--port <port>] --get
       parled12a [--port <port>] --help
Options:
       --port <port>  - IO port numberic address or one of special values:
                        LPT1 - 0x3BC (default),
                        LPT2 - 0x378,
                        LPT3 - 0x278.
Modes:
       --set <value> - set activity of 12 leds. Value - is number, where each of
                       12 bits represent activity of corresponding led.
                       Special values:
                           all - turn on all leds,
                           none - turn off all leds.
       --get - get activity of 12 leds. Value - is number, where each of 12 bits
               represent activity of corresponding led.
       --help - show this help
```

Главный недостаток этой программы заключается в том, что она может работать только с одной реализацией параллельного порта. Если полноценный параллельный порт будет иметь другую реализацию, то эта программа не сможет с ней работать, даже несмотря на наличие в операционной системе соответствующих драйверов.

parled12b.c - управление светодиодами осуществляется через специальный файл /dev/parport0, при помощи которого можно реализовывать драйверы пространства пользователя для устройств, подключаемых к параллельному порту. При запуске без аргументов программа выводит справку по использованию:

```
Usage: parled12b [--devpath <devpath>] --set <value>
       parled12b [--devpath <devpath>] --get
       parled12b --help
Options:
       --devpath <devpath>  - path to parport device, default - /dev/parport0
Modes:
       --set <value> - set activity of 12 leds. Value - is number, where each of
                       12 bits represent activity of corresponding led.
                       Special values:
                           all - turn on all leds,
                           none - turn off all leds.
       --get - get activity of 12 leds. Value - is number, where each of 12 bits
               represent activity of corresponding led.
       --help - show this help
Known bugs:
       Option --get cannot return correct value of high 4 bits, because linux
       driver of parallel port resets the control bits when port opened.
```

Этот вариант программы лишён недостатков предыдущей, однако у неё есть собственный недостаток - при каждом запуске она повторно инициализирует параллельный порт, в результате чего невозможно прочитать состояние 4 управляющих линий, которое было до запуска программы.

Для сборки программ из исходных текстов можно воспользоваться скриптом make.sh

Каталог scheme
--------------

В этом каталоге находятся:
* файл bread_board.sch - электрическая принципиальная схема отладочного устройства,
* файл printed_circuit_borad.sch - электрическая принципиальная схема окончательного устройства,
* каталог symbols - библиотека элементов для обеих принципиальных схем,
* файл printed_circuit_board.pcb - разведённая печатная плата для окончательного устройства,
* gafrc - файл с настройками проекта.

Изначально на параллельный порт не было никакого стандарта, IBM выпускала компьютеры и принтеры к ним, которые работали по этому интерфейсу. Производители клонов компьютеров IBM PC использовали для реализации параллельного порта такие же микросхемы, как IBM, а другие производители принтеров ориентировались на возможности микросхемы. Потом микросхемы для реализации параллельного порта стали выпускать другие производители, дополняя их новыми возможностями. Когда различных реализаций и дополнений накопилось слишком много, комитет IEEE выпустил стандарт на параллельный порт, который в той или иной мере вобрал в себя сложившиеся дополнения и расширения параллельного порта.

IEEE требует денег за получение доступа к своим стандартам, но в сети можно найти множество других документов, написанных по мотивам стандарта. В частности, один из таких документов можно найти по ссылке [Стандарт IEEE 1284](http://www.rusdoc.ru/material/hardware/iee/ieee_1284.htm). Согласно этому документу, напряжение высокого уровня на выходах составляет 2,4 Вольт, а сила вытекающего тока может достигать максимум 14 мА. Выходное напряжение низкого уровня на выходах составляет 0,4 Вольта, а сила тока, втекающего в вывод может достигать тех же 14 мА.

Для устройства были выбраны сверхъяркие светодиоды с максимальной силой тока - 20 мА.

Таким образом сила тока, протекающего через светодиоды и выводы параллельного порта, не должна превышать 14 мА. Падение напряжения на светодиоде составляет 1,8 Вольт. Исходя из этих данных, посчитаем величину сопротивления резисторов, ограничивающих силу тока, а также мощность, рассеиваемую на каждом из резисторов:

```
    U - dU   2.4 - 1.8
R = ------ = --------- = 43 Ом
      I       0.014

W = (U - dU) * I = (2.4 - 1.8) * 0.014 = 0.0084 Вт
```

Схемы и библиотека элементов выполнены в программе gschem из программного пакета gEDA. Разводка печатной платы выполнена в программе PCB.

Сначала была выполнена черновая разводка печатной платы, которая позволила оценить минимальные размеры необходимого корпуса для устройства. После подбора подходящего корпуса печатная плата была отредактирована так, чтобы она подходила к найденному корпусу. Именно по этой причине компоненты на плате располагаются довольно просторно. При промышленном изготовлении можно было бы использовать SMD-компоненты для минимизации размеров и цены устройства, корпус спроектировать специально для устройства, а не подбирать наиболее подходящий из имеющихся в продаже. Не стоит, однако, расчитывать, что это устройство могло бы по-настоящему заинтересовать кого-то, кроме начинающих радиолюбителей. Так что промышленным способом такое устройство можно было бы производить разве что в качестве радиоконструктора - набора деталей для самостоятельной сборки.

Ниже приведена оценка стоимости деталей устройства, без учёта материалов, инструментов и работы:

```
№ Наименование позиции                                    Количество Цена за штуку Цена
- ------------------------------------------------------- ---------- ------------- --------
1 Светодиод круглый матовый 3мм LED DIP 3mm DFL-3014URD-6         12       12.00р. 144.00р.
2 Резистор 47,0 Ом, 0,125/0,25 Вт                                 12        2.00р.  24.00р.
3 Разъем DRB-25MA                                                  1       33.00р.  33.00р.
4 Стеклотекстолит односторонний СФ1-35Г, 100*100*1,5мм             1       35.00р.  35.00р.
5 Корпус для РЭА, МАСТЕР КИТ BOX-KA12 (90x65x35)                   1      130.00р. 130.00р.
6 Шнур XYC008 (1.8м), удлинитель LPT DB25F-DB25M                   1      160.00р. 160.00р.
-------------------------------------------------------------------------------------------
Итого                                                                              526.00р.
```

Каталог daemon
--------------

В этом каталоге находятся исходные тексты демона для управления устройством. Демон написан на языке Си, прослушивает Unix-сокет, принимая новые подключения и команды от подключившихся клиентов. Демон реализован по схеме "конечный автомат", обрабатывает события на сокетах в рамках одного однопоточного процесса при помощи системных вызовов epoll.

Поскольку вторая тестовая программа - parled12b.c - обладала "фатальным" недостатком, не позволяющим прочитать состояние 4 управляющих линий параллельного порта, каким оно было до запуска программы, то для решения этой проблемы я решил реализовать демона, который бы постоянно держал открытым устройство параллельного порта, чтобы драйвер не инициализировал и не сбрасывал состояние этих управляющих линий при каждом повторном открытии порта. Реализация демона получилась далеко не простой, потому что я решил воспользоваться этой задачей как удачной возможностью для освоения различных приёмов системного программирования: освоил демонизацию процесса, сброс привилегий, использование сигналов, использование системного вызова epoll, обработку подключений по схеме "конечный автомат" в рамках однопоточного процесса, освоил работу с syslog.

Демона можно собрать в "тяжёлом" и "облегчённом" вариантах. Для сборки можно воспользоваться имеющимся в каталоге скриптом make.sh.

"Тяжёлый" вариант содержит ведущий процесс, который выполняет подготовку к запуску ведомого процесса, прибирает систему за ним, перезапускает его при неожиданном завершении, подаёт ему сигнал завершения работы. Этот вариант демона расчитан на запуск через систему инициализации System V. Если запустить "тяжёлый" вариант демона из командной строки, не указывая аргументы, он выведет краткую справку по использованию:

```
Usage: parled12 <options>
       parled12 --help
Options:
       --parport <parport>    - path to parport device, default - /dev/parport0
                                The option can be specified multiple times.
       --socket <socket>      - path to listen unix-socket, default - 
                                /run/parled.sock
       --socket-owner <user>  - owner of socket
       --socket-group <group> - group of socket
       --socket-mode <mode>   - access mode for socket
       --daemon               - run as daemon
       --user <user>          - switch to specified user after open all sockets
                                and devices
       --group <group>        - switch to specified group after open all sockets
                                and devices
       --chroot <path>        - change root path of process to specified path
       --pidfile <PID-file>   - path to file, where will be saved PID, default -
                                none
Modes:
       <default> - listen commands on socket and work with leds on parallel
                   port.
       --help    - show this help
```

"Лёгкий" вариант содержит только ведомый процесс. Этот вариант демона расчитан на запуск через систему инициализации systemd, которая позволяет реализовать все функции ведущего процесса из "тяжёлого" варианта путём задания соответствующих настроек инициализации. В этом варианте не поддерживаются опции `--daemon` и `--pidfile`, т.к. демон работает только в интерактивном режиме, а systemd позволяет отслеживать его работу при помощи cgroups - контрольной группы процессов. Его справка в целом аналогична:

```
Usage: parled12 <options>
       parled12 --help
Options:
       --parport <parport>    - path to parport device, default - /dev/parport0
                                The option can be specified multiple times.
       --socket <socket>      - path to listen unix-socket, default - 
                                /run/parled.sock
       --socket-owner <user>  - owner of socket
       --socket-group <group> - group of socket
       --socket-mode <mode>   - access mode for socket
       --user <user>          - switch to specified user after open all sockets
                                and devices
       --group <group>        - switch to specified group after open all sockets
                                and devices
       --chroot <path>        - change root path of process to specified path
Modes:
       <default> - listen commands on socket and work with leds on parallel
                   port.
       --help    - show this help
```

При помощи опции `--parport` можно указать специальные файлы параллельных портов, светодиодами на которых должен управлять демон. Порты нумеруются, начиная с нуля, клиент в командах демону может указывать номер порта явным образом.

Опции `--socket`, `--socket-owner`, `--socket-group`, `--socket-mode` позволяют указать путь к Unix-сокету, владельца, группу владельца, режим доступа. Через этот Unix-сокет будут приниматься подключения клиентов.

Опция `--daemon` позволяет переключить программу из интерактивного режима в режим демона. В интерактивном режиме программа не отделяется от консоли и пишет отладочные сообщения на стандартный вывод. В режиме демона программа отделяется от консоли, от родительского процесса, от группы процессов и делится на два процесса - ведущий и ведомый. Ведущий процесс ловит сигналы: при внезапном завершении ведомого, ведущий процесс перезапускает ведомого, а при получении сигнала завершения работы - завершает ведомого и удаляет PID-файл и Unix-сокет. Ведомый открывает необходимые специальные файлы параллельных портов и Unix-сокет, после чего сбрасывает привилегии и начинает принимать входящие подключения и обслуживать запросы.

Опции `--user`, `--group`, `--chroot` позволяют настроить сброс привилегий ведомым процессом. После открытия необходимых специальных файлов параллельных портов и Unix-сокета, ведомый процесс может перейти в указанную chroot-среду и сменить свой эффективный идентификатор пользователя и группы.

Опция `--pidfile` позволяет указать путь к файлу, в котором будет храниться идентификатор ведущего процесса.

Для управления светодиодами можно воспользоваться утилитой командной строки socat, которую можно установить из одноимённого пакета. При помощи следующей команды можно соединить стандартный ввод-вывод с Unix-сокетом /run/parled.sock, который прослушивается демоном:
    $ socat UNIX:/run/parled.sock STDIO

Подключившись к демону таким образом, можно отправлять ему одну из следующих команд:
* `get leds [from port <port>]` - Возвращает шестнадцатеричное число, младшие 3 цифры которого соответствую состоянию 12 светодиодов. Единичный бит в каждой цифре соответствует светящемуся светодиоду, а ноль - погашенному.
* `set <bits> leds [on port <port>]` - Задаёт состояние 12 светодиодов. В качестве аргумента bits выступает десятичное, восьмеричное или шестнадцатеричное число, 12 младших бит которого соответствуют состоянию 12 светодиодов. Вместо числа можно указать константу all или none. Константа all соответствует 12 единичным битам, а константа none - 12 нулевым битам.
* `not leds [on port <port>]` - Обращает состояние всех светодиодов на противоположное: светящиеся светодиоды гасятся, а погашенные светодиоды включаются.
* `or <bits> leds [on port <port>]` - Выполняет со светодиодами логическую побитовую операцию ИЛИ: в дополнение к уже светящимся светодиодам включатся указанные единичными битами аргумента.
* `and <bits> leds [on port <port>]` - Выполняет со светодиодами логическую побитовую операцию И: из уже светящихся светодиодов останутся включенными только указанные единичными битами аргумента.
* `xor <bits> leds [on port <port>]` - Выполняет со светодиодами логическую побитовую операцию ИСКЛЮЧАЮЩЕЕ ИЛИ: состояние светодиодов, указанных единичными битами аргумента, будет обращено на обратное.
* `add <bits> leds [on port <port>]` - Добавляет к состоянию светодиодов, выраженному в виде числа, число, указанное в аргументе. От результата сложения берутся только 12 младших бит, которые задают новое состояние светодиодов.
* `sub <bits> leds [on port <port>]` - Вычитает из состояния светодиодов, выраженного в виде числа, число, указанное в аргументе. От результата вычитания берутся только 12 младших бит, которые задают новое состояние светодиодов.
* `inc leds [on port <port>]` - Добавляет к состоянию светодиодов, выраженному в виде числа, единицу. От результата сложения берутся только 12 младших бит, которые задают новое состояние светодиодов.
* `dec leds [on port <port>]` - Вычитает из состояния светодиодов, выраженного в виде числа, единицу. От результата вычитания берутся только 12 младших бит, которые задают новое состояние светодиодов.
* `rs <shift> leds [on port <port>]` - Сдвиг битов, соответствующих состоянию светодиодов, вправо на указанное количество позиций. Лишние биты отбрасываются, а новые биты слева принимают нулевое значение. Аргумент может принимать любое значение, однако сдвиг на 0 битов и на более чем 11 битов не имеют особого смысла: в первом случае состояние светодиодов не меняется, а во втором случае все светодиоды будут погашены.
* `ls <shift> leds [on port <port>]` - Сдвиг битов, соответствующих состоянию светодиодов, влево на указанное количество позиций. Лишние биты отбрасываются, а новые биты справа принимают нулевое значение. Аргумент может принимать любое значение, однако сдвиг на 0 битов и на более чем 11 битов не имеют особого смысла: в первом случае состояние светодиодов не меняется, а во втором случае все светодиоды будут погашены.
* `rcs <shift> leds [on port <port>]` - Циклический сдвиг битов вправо: вытесненные вправо биты будут добавлены слева. Сдвиг на 0 битов и на количество, кратное 12, не меняет состояния светодиодов. Сдвиг на более чем 12 битов имеет такой же эффект, как сдвиг на остаток от деления на 12.
* `lcs <shift> leds [on port <port>]` - Циклический сдвиг битов влево: вытесненные влево биты будут добавлены справа. Сдвиг на 0 битов и на количество, кратное 12, не меняет состояния светодиодов. Сдвиг на более чем 12 битов имеет такой же эффект, как сдвиг на остаток от деления на 12.
* `exit` - Завершение работы: по этой команде демон разрывает соединение с клиентом.
* `quit` - Завершение работы: по этой команде демон разрывает соединение с клиентом.
* `close` - Завершение работы: по этой команде демон разрывает соединение с клиентом.
* `logout` - Завершение работы: по этой команде демон разрывает соединение с клиентом.


Демон способен управлять несколькими устройствами, подлкюченными к нескольким параллельным портам, для чего в командах предусмотрены варианты `on port <port>` и `from port <port>`. Вместо `<port>` в команде указывается порядковый номер порта, указанный в опциях демона. Нумерация портов в этих командах начинается с нуля. Если указан только один порт, то указывать номер порта не обязательно.

Каталог init
------------

В этом каталоге находится два файла инициализации:
* parled12-sysvinit - скрипт для системы инициализации в стиле System V,
* parled12.service - юнит-файл для системы инициализации systemd.

Первый скрипт инициализации использует настройки из файла /etc/default/parled12, который может иметь, например, следующее содержимое:
    PIDFILE=/run/praled12.pid
    DAEMON_OPTS="--parport /dev/parport0 --socket /run/parled12.sock --socket-owner root --socket-group root --socket-mode 0666 --user nobody --group nogroup --chroot /var/spool/parled12"

Для установки файла инициализации в системе инициализации в стиле System V и для запуска демона нужно выполнить следующие команды:
    # cp parled12-sysvinit /etc/init.d/parled12
    # insserv parled12
    # /etc/init.d/parled12 start

Юнит-файл systemd тоже использует настройки из файла /etc/default/parled12, однако переменная PIDFILE им не используется, из-за чего этот файл может принимать следующий вид:
    DAEMON_OPTS="--parport /dev/parport0 --socket /run/parled12.sock --socket-owner root --socket-group root --socket-mode 0666 --user nobody --group nogroup --chroot /var/spool/parled12"

Для установки юнит-файла инициализации в системе инициализации systemd и для запуска демона нужно выполнить следующие команды:
    # cp parled12.service /etc/systemd/system/
    # systemctl daemon-reload
    # systemctl enable parled12.service
    # systemctl start parled12.service

(C) 2018 Владимир Ступин

Исходные тексты распространяются под лицензией GPL 3.
